<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Hecho - MetaMapa</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/styles.css}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
</head>
<body>
<!-- Navbar -->
<div th:replace="layout/navbar :: navbar( ${rol})"></div>

<div class="container">
    <!-- Converted header to editable form -->
    <form class="hecho-header" id="editForm" th:action="@{/hechos/editar}" th:object="${hecho}" method="post" enctype="multipart/form-data">

        <input type="hidden" th:field="*{id}" />

        <div class="form-group">
            <label class="form-label" for="titulo">Título del Hecho</label>
            <input type="text" id="titulo" th:field="*{titulo}" class="form-input" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="categoria">Categoría</label>
            <select id="categoria" th:field="*{categoria}" class="form-select" required>
                <option value="desastre-natural" th:selected="${hecho.categoria == 'desastre-natural'}">Desastre Natural</option>
                <option value="accidente" th:selected="${hecho.categoria == 'accidente'}">Accidente</option>
                <option value="evento-social" th:selected="${hecho.categoria == 'evento-social'}">Evento Social</option>
                <option value="construccion" th:selected="${hecho.categoria == 'construccion'}">Construcción</option>
                <option value="transporte" th:selected="${hecho.categoria == 'transporte'}">Transporte</option>
                <option value="otro" th:selected="${hecho.categoria == 'otro'}">Otro</option>
            </select>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="fechaHecho">Fecha del Hecho</label>
                <input type="date" id="fechaHecho" th:field="*{fechaHecho}" class="form-input" required
                       th:value="${#temporals.format(hecho.fechaHecho, 'yyyy-MM-dd')}">
            </div>
            <div class="form-group">
                <label class="form-label" for="fechaPublicacion">Fecha de Publicación</label>
                <input type="date" id="fechaPublicacion" th:field="*{fechaCreacion}" class="form-input" required
                       th:value="${#temporals.format(hecho.fechaCreacion, 'yyyy-MM-dd')}">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="ubicacion">Ubicación</label>
            <input type="text" id="ubicacion" th:value="${hecho.ubicacion != null ? hecho.ubicacion.localidad.nombre : ''}" class="form-input" required>
        </div>

        <!-- Galería multimedia -->
        <div class="galeria-section">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="images"></i>
                Imágenes del Hecho
            </h3>

            <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
                <i data-lucide="upload" style="font-size: 2rem; color: var(--text-light); margin-bottom: 0.5rem;"></i>
                <p style="color: var(--text-light); margin: 0;">
                    Haz clic aquí o arrastra imágenes para subir
                </p>
                <small style="color: var(--text-light);">
                    Formatos soportados: JPG, PNG, GIF (máx. 5MB cada una)
                </small>
            </div>

            <input type="file" id="imageInput" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(event)">

            <div class="uploaded-images" id="uploadedImages">
                <!-- Mostrar imágenes existentes -->
                <div class="uploaded-image" th:each="media : ${hecho.multimedia}">
                    <img th:src="${media.url}" th:alt="'Imagen del hecho: ' + ${hecho.titulo}">
                    <button type="button" class="remove-image" onclick="removeImage(this)">
                        <i data-lucide="x"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Descripción -->
        <div class="descripcion">
            <label class="form-label" for="descripcion">Descripción del Hecho</label>
            <textarea id="descripcion" th:field="*{descripcion}" class="form-textarea" required></textarea>
        </div>

        <!-- Botones -->
        <div class="form-actions">
            <a th:href="@{'/hecho/' + ${hecho.id}}" class="btn btn-secondary">
                <i data-lucide="x"></i> Cancelar
            </a>
            <button type="button" class="btn btn-danger">
                <i data-lucide="trash-2"></i> Eliminar
            </button>
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save"></i> Guardar Cambios
            </button>
        </div>

    </form>

</div>

<!-- Footer -->
<div th:replace="~{layout/footer :: footer}"></div>

<script>
    lucide.createIcons();

    function handleImageUpload(event) {
      const files = event.target.files;
      const uploadedImages = document.getElementById('uploadedImages');

      Array.from(files).forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'uploaded-image';
            imageDiv.innerHTML = `
              <img src="${e.target.result}" alt="Imagen subida">
              <button type="button" class="remove-image" onclick="removeImage(this)">
                <i data-lucide="x"></i>
              </button>
            `;
            uploadedImages.appendChild(imageDiv);
            lucide.createIcons();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function removeImage(button) {
      button.parentElement.remove();
    }

    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      alert('Cambios guardados exitosamente!');
    });
</script>
</body>
</html>
