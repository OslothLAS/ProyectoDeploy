<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMapa - Dashboard Administrador</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/styles.css}" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>
<body>
<!-- Navbar -->
<div th:replace="layout/navbar :: navbar( ${rol})"></div>

<div class="dashboard-section">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Dashboard de Solicitudes</h1>
            <p>Gestión centralizada de solicitudes de eliminación de hechos y moderación de contenido</p>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="icon"><i data-lucide="clock"></i></div>
                <h3 id="pendingCount" th:text="${solicitudes.?[estado == 'PENDIENTE'].size()}">0</h3>
                <p>Solicitudes Pendientes</p>
            </div>
            <div class="stat-card">
                <div class="icon"><i data-lucide="check-circle"></i></div>
                <h3 id="approvedCount" th:text="${solicitudes.?[estado == 'ACEPTADA'].size()}">0</h3>
                <p>Solicitudes Aprobadas</p>
            </div>
            <div class="stat-card">
                <div class="icon"><i data-lucide="x-circle"></i></div>
                <h3 id="rejectedCount" th:text="${solicitudes.?[estado == 'RECHAZADA'].size()}">0</h3>
                <p>Solicitudes Rechazadas</p>
            </div>
            <div class="stat-card">
                <div class="icon"><i data-lucide="list"></i></div>
                <h3 id="totalSolicitudes" th:text="${solicitudes.size()}">0</h3>
                <p>Total de Solicitudes</p>
            </div>
        </div>

        <!-- Requests Container -->
        <div class="requests-container">
            <div class="requests-header">
                <h2>Solicitudes de Eliminación</h2>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterRequests('all')">Todas</button>
                    <button class="filter-tab" onclick="filterRequests('PENDIENTE')">Pendientes</button>
                    <button class="filter-tab" onclick="filterRequests('ACEPTADA')">Aprobadas</button>
                    <button class="filter-tab" onclick="filterRequests('RECHAZADA')">Rechazadas</button>
                </div>
            </div>

            <div id="requestsList">
                <div th:each="solicitud : ${solicitudes}" class="request-item"
                     th:attr="data-status=${solicitud.estado}">

                    <div class="request-header">
                        <div class="request-info">
                            <h4 th:text="'Hecho #' + ${solicitud.idHecho} + ' - ' + ${solicitud.estado.toLowerCase()}"></h4>
                            <div class="request-meta">
                                <span><i data-lucide="calendar"></i>
                                    <span th:text="${#temporals.format(solicitud.fechaDeCreacion, 'dd MMM yyyy')}"></span>
                                </span>
                                <span><i data-lucide="user"></i>
                                    <span th:text="${solicitud.username != null ? solicitud.username : 'Usuario Anónimo'}"></span>
                                </span>
                                <span><i data-lucide="user-check"></i>
                                    <span th:text="${solicitud.evaluador != null ? solicitud.evaluador : 'Sin evaluador'}"></span>
                                </span>
                            </div>
                        </div>

                        <span th:class="${'status-badge ' + (solicitud.estado == 'PENDIENTE' ? 'status-pending' : (solicitud.estado == 'ACEPTADA' ? 'status-approved' : 'status-rejected'))}"
                              th:text="${solicitud.estado.toLowerCase()}">
                        </span>
                    </div>

                    <div class="request-reason" th:text="${solicitud.justificacion}"></div>

                    <div class="request-actions">
                        <form th:action="@{/hechoColeccion/{id}(id=${solicitud.id})}" method="get" style="display:inline">
                            <input type="hidden" name="_method" value="get"/>
                            <button type="submit" class="btn-small btn-ver-hecho">
                                <i data-lucide="."></i> Ver Hecho
                            </button>
                        </form>


                        <form th:if="${rol == 'ROLE_ADMIN'}"
                              th:action="@{/solicitudEliminacion/{id}/aceptar(id=${solicitud.id})}"
                              method="post" style="display:inline">
                            <button type="submit" class="btn-small btn-reject">
                                <i data-lucide="check"></i> Eliminar Hecho
                            </button>
                        </form>

                        <!-- SOLO ADMIN: Rechazar -->
                        <form th:if="${rol == 'ROLE_ADMIN'}"
                              th:action="@{/solicitudEliminacion/{id}/rechazar(id=${solicitud.id})}"
                              method="post" style="display:inline">
                            <button type="submit" class="btn-small btn-approve">
                                <i data-lucide="x"></i> Mantener hecho
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i data-lucide="inbox"></i>
                    <h3>No hay solicitudes</h3>
                    <p>No se encontraron solicitudes que coincidan con el filtro seleccionado.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<div th:replace="~{layout/footer :: footer}"></div>

<script>
    lucide.createIcons();

    function filterRequests(status) {
        const items = document.querySelectorAll('.request-item');
        const tabs = document.querySelectorAll('.filter-tab');
        const emptyState = document.getElementById('emptyState');

        tabs.forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        let visibleCount = 0;

        items.forEach(item => {
            const itemStatus = item.dataset.status;
            if (status === 'all' || itemStatus === status) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function viewFactDetails(id) {
        alert(`Abriendo detalles del hecho ID: ${id}`);
    }

    function approveRequest(id) {
        if (confirm('¿Estás seguro de que deseas aprobar esta solicitud de eliminación?')) {
            alert(`Solicitud ${id} aprobada. El hecho será eliminado.`);
        }
    }

    function rejectRequest(id) {
        const reason = prompt('Ingresa la razón del rechazo (opcional):');
        if (reason !== null) {
            alert(`Solicitud ${id} rechazada. Razón: ${reason || 'No especificada'}`);
        }
    }
</script>
</body>
</html>