<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Colecci√≥n | MetaMapa</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family:'DM Sans', sans-serif; margin:0; background:#f9fafb; }
        nav { background:white; border-bottom:1px solid #ddd; padding:1rem 2rem; }
        .nav-container { max-width:800px; margin:auto; display:flex; justify-content:space-between; align-items:center; }
        .logo { font-weight:700; font-size:1.5rem; color:#0891b2; text-decoration:none; }
        main { max-width:800px; margin:2rem auto; padding:2rem; background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
        label { font-weight:600; display:block; margin-top:1rem; }
        input, textarea, select { width:100%; padding:0.75rem; margin-top:0.3rem; border:1px solid #ddd; border-radius:6px; }
        .btn { padding:0.7rem 1.2rem; border:none; border-radius:6px; cursor:pointer; font-weight:600; margin-top:1.5rem; }
        .btn-primary { background:#0891b2; color:white; }
        .btn-secondary { background:#6b7280; color:white; }
        .form-actions { display:flex; gap:1rem; margin-top:2rem; }
        .fuente-group { display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-bottom:1rem; }
        .remove-btn { background:#ef4444; color:white; border-radius:6px; padding:0.5rem; cursor:pointer; }
    </style>
</head>
<body>
<nav>
    <div class="nav-container">
        <a th:href="@{/colecciones}" class="logo">‚Üê MetaMapa</a>
        <span id="formMode"></span>
    </div>
</nav>

<main>
    <h1 th:text="${coleccion.id != null} ? 'Editar Colecci√≥n' : 'Nueva Colecci√≥n'">Nueva Colecci√≥n</h1>

    <form th:action="@{/colecciones}" th:object="${coleccion}" method="post">
        <input type="hidden" th:field="*{id}" />

        <label>T√≠tulo</label>
        <input type="text" th:field="*{titulo}" required>

        <label>Descripci√≥n</label>
        <textarea th:field="*{descripcion}" required></textarea>

        <label>Fuentes</label>
        <div id="fuentesContainer">
            <div class="fuente-group" th:each="fuente, iterStat : *{fuentes}">
                <input type="text" th:field="*{fuentes[__${iterStat.index}__].ip}" placeholder="IP" required>
                <input type="text" th:field="*{fuentes[__${iterStat.index}__].puerto}" placeholder="Puerto" required>
                <select th:field="*{fuentes[__${iterStat.index}__].tipo}" required>
                    <option value="ESTATICA">Est√°tica</option>
                    <option value="DINAMICA">Din√°mica</option>
                    <option value="PROXY">Proxy</option>
                </select>
                <button type="button" class="remove-btn" onclick="removeFuente(this)">√ó</button>
            </div>
        </div>
        <button type="button" class="btn btn-secondary" onclick="addFuente()">+ Agregar Fuente</button>

        <label>Estrategia de Consenso</label>
        <select th:field="*{estrategiaConsenso}" required>
            <option value="MULTIPLE_MENCION">M√∫ltiples menciones</option>
            <option value="ABSOLUTA">Absoluta</option>
            <option value="MAYORIA">Mayor√≠a simple</option>
        </select>

        <label>Categor√≠a</label>
        <select th:field="*{criterios[0].valor}" required>
            <option value="AMBIENTAL">Ambiental</option>
            <option value="SOCIAL">Social</option>
            <option value="ECONOMICO">Econ√≥mico</option>
            <option value="POLITICO">Pol√≠tico</option>
        </select>
        <input type="hidden" th:field="*{criterios[0].tipo}" value="categoria" />

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">üíæ Guardar</button>
            <a th:href="@{/colecciones}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</main>

<script>
    function addFuente() {
      const container = document.getElementById("fuentesContainer");
      const index = container.children.length;
      const div = document.createElement("div");
      div.className = "fuente-group";
      div.innerHTML = `
        <input type="text" name="fuentes[${index}].ip" placeholder="IP" required>
        <input type="text" name="fuentes[${index}].puerto" placeholder="Puerto" required>
        <select name="fuentes[${index}].tipo" required>
          <option value="ESTATICA">Est√°tica</option>
          <option value="DINAMICA">Din√°mica</option>
          <option value="PROXY">Proxy</option>
        </select>
        <button type="button" class="remove-btn" onclick="removeFuente(this)">√ó</button>
      `;
      container.appendChild(div);
    }

    function removeFuente(btn) {
      btn.parentElement.remove();
      // Reindexar campos
      const container = document.getElementById("fuentesContainer");
      Array.from(container.children).forEach((div, idx) => {
        div.querySelectorAll("input, select").forEach(input => {
          const name = input.name;
          const newName = name.replace(/\[\d+\]/, `[${idx}]`);
          input.name = newName;
        });
      });
    }
</script>
</body>
</html>
